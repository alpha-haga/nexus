# NEXUS 依存ルール・アーキテクチャ制約

本文書は NEXUS のモジュール間依存ルール・会計連携方針・Task 設計を定義する。

---

## 1. ドメイン間依存ルール

### 依存方向の原則

```
許可される依存方向:
  業務ドメイン → 共通基盤      ✅ 許可
  横断業務 → 共通基盤          ✅ 許可
  API/Batch → 業務ドメイン     ✅ 許可

禁止される依存方向:
  共通基盤 → 業務ドメイン      ❌ 禁止
  業務ドメイン → 業務ドメイン  ❌ 禁止（参照用サービス経由のみ許可）
  reporting/group → 更新処理   ❌ 禁止（Read Only）
```

### 依存関係図

```
                    ┌─────────────────────────────────────────┐
                    │              nexus-api / nexus-batch     │
                    │            （業務モジュールを束ねる）      │
                    └─────────────────┬───────────────────────┘
                                      │ 依存
        ┌─────────────────────────────┼─────────────────────────────┐
        │                             │                             │
        ▼                             ▼                             ▼
┌───────────────┐           ┌───────────────┐           ┌───────────────┐
│   nexus-gojo   │           │ nexus-funeral  │           │  nexus-point   │
│   (互助会)     │           │   (葬祭)       │           │  (ポイント)    │
└───────┬───────┘           └───────┬───────┘           └───────┬───────┘
        │                           │                           │
        │ 参照のみ ─────────────────┘                           │
        │                                                       │
        └───────────────────────┬───────────────────────────────┘
                                │ 依存
                                ▼
                    ┌─────────────────────────┐
                    │       nexus-core         │
                    │  （誰にも依存しない）     │
                    └─────────────────────────┘
```

### 禁止方向の明示

| 依存元 | 依存先 | 可否 | 理由 |
|--------|--------|------|------|
| nexus-core | 任意のモジュール | ❌ | core は依存グラフの根 |
| nexus-identity | nexus-gojo | ❌ | 共通基盤は業務を知らない |
| nexus-identity | nexus-funeral | ❌ | 共通基盤は業務を知らない |
| nexus-gojo | nexus-funeral | ❌ | 業務間の直接依存は禁止 |
| nexus-funeral | nexus-gojo | △ | 参照用サービス経由のみ許可 |
| nexus-reporting | 任意（更新） | ❌ | Read Only モジュール |
| nexus-group | 任意（更新） | ❌ | Read Only モジュール |

### identity の特殊な位置付け

identity は Person / Household の **生成元** だが、以下を持たない：

- 業務判断ロジック（契約可否、権利有無など）
- 業務固有の属性（契約者フラグ、会員ランクなど）
- 他ドメインへの依存

```kotlin
// identity の責務
class PersonService {
    fun create(name: PersonName, address: Address): Person  // 生成のみ
    fun findById(id: PersonId): Person?                     // 参照のみ
    fun merge(from: PersonId, to: PersonId)                 // 名寄せ
}

// identity が持たないもの
fun isContractor(id: PersonId): Boolean  // NG: 契約判断は gojo の責務
fun getPointBalance(id: PersonId): Long  // NG: 残高管理は point の責務
```

---

## 2. 会計連携の設計

### 基本思想

**業務イベントと会計仕訳を分離する**

```
業務ドメイン → 会計イベント（Fact）発行 → accounting → 仕訳生成
```

### gojo と funeral の会計連携差

| 観点 | gojo（互助会） | funeral（葬祭） |
|------|---------------|-----------------|
| 仕訳タイミング | 積立入金時にイベント発行 | 施行完了・精算時にイベント発行 |
| 仕訳生成 | accounting で月次集約 | accounting で案件単位 or 月次締め |
| 結合度 | 契約・支払と accounting の連携が密 | 業務完結後に会計連携 |

### gojo の会計連携

```
┌─────────────┐     積立入金 Fact      ┌─────────────┐
│  nexus-gojo  │ ──────────────────▶ │  accounting  │
│              │                      │              │
│ 契約・積立   │     月次で集約        │ 仕訳生成     │
└─────────────┘                      └─────────────┘
```

- gojo は「積立が発生した」という Fact を発行
- accounting は月次締めで Fact を集約し、仕訳を生成

### funeral の会計連携

```
┌──────────────┐    施行完了 Fact     ┌─────────────┐
│ nexus-funeral │ ─────────────────▶ │  accounting  │
│               │                     │              │
│ 案件・施行    │    締め単位で仕訳    │ 仕訳生成     │
└──────────────┘                     └─────────────┘
```

- funeral は「施行が完了した」「精算が完了した」という Fact を発行
- **funeral は即時仕訳を生成しない**
- accounting が月次・締め単位で仕訳を生成

### 仕訳生成のタイミング

| パターン | 説明 | 適用例 |
|---------|------|--------|
| 即時生成 | Fact 受信時に仕訳作成 | 現金入金など確定的な取引 |
| 日次集約 | 日次バッチで仕訳作成 | 大量の小口取引 |
| 月次締め | 月次締め処理で仕訳作成 | 積立集計、売上確定 |

**重要**: 仕訳生成タイミングの判断は accounting の責務。業務ドメインは Fact を発行するのみ。

---

## 3. Task / State / Phase の共通概念

### 基本思想

業務は「タスク（Task）」として扱い、状態遷移で管理する。
State / Phase は **全ドメイン共通の概念** であり、ドメイン固有の状態を定義してはならない。

### State と Phase の分離

| 概念 | 役割 | 管理単位 | 例 |
|------|------|---------|-----|
| State | タスクの承認状態 | システム共通 | DRAFT → REQUESTED → APPROVED |
| Phase | 業務の進行段階 | ドメイン共通 | PREPARATION → IN_PROGRESS → DOCUMENT → COMPLETED |

### State の遷移ルール

```
DRAFT → REQUESTED → IN_PROGRESS → APPROVED / REJECTED / COMPLETED
                               ↘ CANCELLED
```

- State の巻き戻しは禁止（やり直しは新しい Task を作成）
- 各ドメインで独自の State を定義しない

### Phase の標準定義

```
PREPARATION    準備・入力段階
IN_PROGRESS    作業中・処理中
DOCUMENT       書類作成・確認段階（SLA 管理対象）
COMPLETED      完了
```

### DOCUMENT フェーズの扱い

**DOCUMENT は IN_PROGRESS に内包してはならない**

| 分離する理由 |
|-------------|
| DOCUMENT は SLA（サービスレベル）管理の対象 |
| 書類の作成・確認は業務完了とは異なる関心事 |
| DOCUMENT の滞留を可視化・アラートする必要がある |

```kotlin
// 禁止: DOCUMENT を IN_PROGRESS に含める
enum class Phase {
    PREPARATION,
    IN_PROGRESS,  // この中に書類作成を含めない
    COMPLETED
}

// 正しい: DOCUMENT を独立させる
enum class Phase {
    PREPARATION,
    IN_PROGRESS,
    DOCUMENT,     // 独立したフェーズ
    COMPLETED
}
```

### Task の責務制限

- Task は「承認した」という事実のみを記録
- 業務データの直接更新は行わない
- 業務データの更新は業務サービスが行う

---

## 4. 管理ダッシュボードの責務

### 基本原則

管理ダッシュボード（nexus-reporting / 管理画面）は **参照・可視化専用** である。

### 許可される責務

| 責務 | 説明 |
|------|------|
| 状態の横断集約 | 全ドメインの Task / State / Phase を集約 |
| 可視化・表示 | グラフ・一覧・アラート表示 |
| フィルタ・検索 | 条件による絞り込み |
| エクスポート | CSV・帳票出力 |

### 禁止される責務

| 禁止事項 | 理由 |
|---------|------|
| 書き込み・更新処理 | 業務ドメインの責務 |
| 業務判断ロジック | 各ドメインの責務 |
| State / Phase の変更 | 業務サービス経由で行う |
| マスタの正の保持 | 参照キャッシュのみ許可 |

### ダッシュボードの位置付け

```
┌─────────────────────────────────────────────────────┐
│              管理ダッシュボード（Read Only）          │
│                                                     │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐            │
│  │ gojo    │  │ funeral │  │ point   │  ...       │
│  │ 状態集約 │  │ 状態集約 │  │ 状態集約 │            │
│  └────┬────┘  └────┬────┘  └────┬────┘            │
│       │            │            │                  │
│       └────────────┼────────────┘                  │
│                    ▼                               │
│           横断ビュー・アラート                       │
└─────────────────────────────────────────────────────┘
         │ 参照のみ（更新なし）
         ▼
┌─────────────────────────────────────────────────────┐
│  nexus-gojo  │  nexus-funeral  │  nexus-point  │ ...│
│              │                 │               │    │
│  業務ドメイン（更新はここで行う）                     │
└─────────────────────────────────────────────────────┘
```

---

## 5. 将来拡張への対応

### 新ドメイン追加時のチェックリスト

新しいドメイン（bridal, card 等）を追加する際は、以下を確認する：

1. **依存方向**: nexus-core への依存のみか
2. **会計連携**: Fact 発行のみで、仕訳を直接作成していないか
3. **Task 利用**: 共通の State / Phase を使用しているか
4. **identity 参照**: PersonId による参照のみで、更新していないか
5. **禁止事項**: design-principles.md の禁止事項に該当しないか

### モジュール分離の判断基準

サブドメインを独立モジュールに分離する場合：

1. **負荷の偏り**: 特定サブドメインの負荷が突出
2. **チーム分離**: 開発チームの独立運用が必要
3. **デプロイ独立性**: 独立したリリースサイクルが必要

分離時は本文書を更新し、依存ルールを再定義する。

---

## 6. 本文書の位置付け

### 使い方

1. モジュール間の依存を追加する前に、本文書で可否を確認する
2. 会計連携の実装時に、Fact / 仕訳の責務分担を確認する
3. Task 実装時に、State / Phase の共通定義を参照する

### 更新ルール

- 依存ルールの変更は本文書を更新してから実装する
- 「例外」を増やすのではなく、ルール自体を見直す
- 更新時は PR でレビューを受ける

---

## 関連ドキュメント

| ドキュメント | 内容 |
|-------------|------|
| [README.md](../../README.md) | システム概要・判断基準 |
| [design-principles.md](./design-principles.md) | 設計原則・ドメイン境界 |
| [overview.md](./overview.md) | 全体像・データの流れ |
| [common/task/README.md](../../common/task/README.md) | Task 共通設計 |
