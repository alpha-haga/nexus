# NEXUS アーキテクチャ概要

本文書は NEXUS の全体構造・責務分担・データの流れを説明する。
実装詳細は各モジュールの README を参照すること。

---

## 1. 全体像（Overview）

### NEXUS が解決する課題

NEXUS は、冠婚葬祭互助会事業における以下の課題を解決する：

- **顧客情報の分散**: 互助会・葬祭・冠婚で顧客情報が別々に管理されている
- **業務間連携の困難**: 互助会契約と葬祭施行の紐付けが手作業
- **会計処理の複雑化**: 業務ごとに異なる会計フローが存在

### システムの位置付け

NEXUS は「業務ドメインを疎結合でつなぐ基幹システム」である。

各業務（互助会・葬祭・冠婚・ポイント）は独立したドメインとして設計されているが、
顧客情報（Person / Household）を共通基盤として共有することで、業務横断の連携を実現する。

### 利用範囲

本システムは社内向けであり、外部公開は前提としない。
利用者は社員（営業・事務・管理部門）および社内システムである。

---

## 2. 論理アーキテクチャ

NEXUS は以下の層構造で構成される。

### UI 層（Frontend）

Next.js による Web アプリケーション。

- ユーザーの操作を受け付け、API を呼び出す
- 認証は NextAuth.js + Keycloak で行う
- 業務ロジックは持たない（表示とバリデーションのみ）

### API 層（nexus-api）

外部公開 API および BFF（Backend For Frontend）。

- Frontend からのリクエストを受け付ける
- 複数ドメインのデータを集約して返却する
- 業務ロジックは持たない（ドメイン層に委譲）

### ドメイン層

業務固有のロジックを持つ層。以下のモジュールで構成される。

- **nexus-gojo**: 互助会の契約・積立・権利管理
- **nexus-funeral**: 葬祭の受付・施行・請求
- **nexus-bridal**: 冠婚の予約・施行・請求
- **nexus-point**: ポイントの付与・利用・残高管理
- **nexus-group**: 全法人横断の検索（参照専用）

各ドメインは独立しており、他ドメインの内部構造を直接参照しない。

### 共通基盤

全ドメインから参照される基盤モジュール。

- **nexus-core**: ID 定義・ValueObject・共通例外（Pure Kotlin、Spring 依存なし）
- **nexus-identity**: Person（個人）の管理・名寄せロジック
- **nexus-household**: Household（世帯）の構成・家族関係管理

共通基盤は業務ロジックを持たず、データの一元管理に特化する。

### 横断業務

複数ドメインにまたがる業務を扱う層。

- **nexus-payment**: 請求・入金・消込の管理
- **nexus-accounting**: 会計仕訳の生成・管理
- **nexus-reporting**: 帳票・集計（参照専用）
- **nexus-agent**: 代理店契約・案件割当・報酬管理

横断業務は業務ドメインからイベントを受け取り、横断的な処理を行う。

### バッチ層（nexus-batch）

定期実行・一括処理を担当する。

- 外部データの取り込み
- 名寄せ補助処理
- 月次締め処理の起動

リアルタイム処理は行わない。

---

## 3. ドメイン間の関係

### identity / household の位置付け

identity（Person）と household（世帯）は、全業務ドメインから参照される。

- gojo: 契約者・受取人として Person を参照
- funeral: 喪主・故人として Person を参照
- bridal: 新郎・新婦として Person を参照
- point: 口座所有者として Person を参照

業務ドメインは identity / household を「参照」するが、「更新」は行わない。
Person / Household の登録・更新は identity / household モジュール経由で行う。

### group の役割

group は「全法人横断ビュー」を提供する。

複数法人のデータを横断検索する必要がある場合、group を経由する。
group は参照専用であり、登録・更新機能を持たない。

### 業務ドメイン間の独立性

業務ドメイン同士（gojo, funeral, bridal, point）は直接依存しない。

- funeral は gojo の契約情報を「参照」するが、gojo の内部構造には依存しない
- bridal は gojo の契約情報を「参照」するが、gojo を直接更新しない
- point は各業務からポイント付与リクエストを受けるが、業務ロジックは持たない

この独立性により、各ドメインを個別に変更・テストできる。

---

## 4. gojo と funeral の違い

### gojo（互助会）の特性

gojo は「契約・積立・権利」を中心とするドメインである。

- 契約は長期（数年〜数十年）にわたる
- 毎月の積立により権利が成熟する
- 権利行使時に葬祭・冠婚と連携する

gojo は「権利の発生と管理」に特化し、施行の詳細は持たない。

### funeral（葬祭）の特性

funeral は「案件・施行」を中心とするドメインである。

- 案件は短期（数日〜数週間）で完結する
- 受付→見積→契約→施行→精算という工程がある
- 互助会権利の有無により請求内容が変わる

funeral は「施行の遂行と精算」に特化し、権利管理は gojo に委ねる。

### 会計処理の違い

会計処理のタイミングが異なる。

**gojo の会計処理:**
- 毎月の積立入金時にイベント発行
- accounting で月次集約し、仕訳を生成

**funeral の会計処理:**
- 施行完了・精算完了時にイベント発行
- accounting で案件単位の仕訳を生成

いずれの場合も、業務ドメインは仕訳を直接作成しない。
仕訳の作成は accounting の責務である。

---

## 5. データとイベントの流れ

### 業務操作からドメインイベントへ

ユーザーの業務操作は、以下の流れで処理される。

1. Frontend から API を呼び出す
2. API 層が該当ドメインのサービスを呼び出す
3. ドメインサービスが業務処理を実行する
4. 業務処理の結果として「ドメインイベント」を発行する

ドメインイベントは「何が起きたか」を表す事実（Fact）である。

### イベントから会計処理へ

発行されたドメインイベントは、accounting で処理される。

1. 業務ドメインがイベントを発行（例: ContractCreated, PaymentReceived）
2. accounting がイベントを受信
3. accounting が仕訳ルールに従い、仕訳を生成

業務ドメインは「何が起きたか」を伝えるだけで、仕訳内容には関与しない。
これにより、仕訳ルールの変更が業務ドメインに影響しない。

### reporting での参照

reporting は各ドメインのデータを集約し、帳票・集計を提供する。

- reporting は参照専用であり、データの登録・更新は行わない
- 各ドメインの公開された参照用サービスを利用する
- 業務ドメインの内部構造には依存しない

### batch の役割

batch は以下の処理を担当する。

- **データ取り込み**: 外部システムからのデータを identity に取り込む
- **名寄せ補助**: 重複 Person の候補抽出・統合支援
- **定期処理**: 月次締め・督促処理などのトリガー

batch はリアルタイム処理を行わず、スケジュール実行または手動起動で動作する。

---

## 6. なぜこの構成なのか

### 既存システムからのリプレイス

NEXUS は既存の複数システムをリプレイスするプロジェクトである。

既存システムは業務ごとに独立しており、以下の課題があった：
- 顧客情報の重複・不整合
- 業務間連携の手作業
- 保守コストの増大

NEXUS は顧客情報を一元化しつつ、業務ドメインの独立性を維持する構成とした。

### 一気に分割しない理由

マイクロサービス化を初期段階で行わない理由は以下の通り。

1. **運用負荷**: 分散システムの運用は複雑である
2. **境界の不確実性**: ドメイン境界が確定する前に分割すると、後から統合が困難
3. **段階移行**: 既存システムとの並行稼働期間中は、変更容易性を優先

モノリス構成だが、モジュール境界は明確に分離している。

### 将来の分離余地

各モジュールは以下の原則で設計されており、将来の分離に備えている。

- ドメイン間の直接依存を禁止
- イベント駆動による疎結合
- 公開インターフェースの明確化

将来、負荷や組織の変化に応じて、特定ドメインを独立サービス化できる。

---

## 7. よくある質問（FAQ）

### Q: なぜマイクロサービスにしていないのか

**A:** 初期段階での分散システム化はリスクが高いため。

- ドメイン境界が確定する前に分割すると、境界の変更が困難になる
- 運用・監視・障害対応の複雑性が増す
- 現時点では単一デプロイで十分なスケーラビリティを確保できる

将来、特定ドメインの負荷が増大した場合は、そのドメインのみを分離できる設計としている。

### Q: なぜ accounting を分離しているのか

**A:** 業務ロジックと会計ルールを分離するため。

- 業務ドメインは「何が起きたか」に責任を持つ
- accounting は「どう仕訳するか」に責任を持つ
- 会計基準や税制の変更が業務ロジックに波及しない

また、月次締めなどのバッチ処理と親和性が高い。

### Q: なぜ Task / State / Phase を共通化しているのか

**A:** 業務横断でのワークフロー管理を統一するため。

- State（承認状態）は全業務で共通の概念である
- Phase（業務進行）は業務ごとに異なるが、管理方式は統一する
- 共通化により、承認フローの横断検索・集計が可能になる

各ドメインが独自の State を定義すると、横断管理が困難になる。

### Q: identity と各業務ドメインの境界はどこか

**A:** identity は「Person とは誰か」を管理し、業務ドメインは「Person との関係」を管理する。

- identity: Person の基本情報（氏名・住所・連絡先）
- gojo: Person が「契約者」「受取人」として持つ契約
- funeral: Person が「喪主」「故人」として関わる案件

業務ドメインは Person の基本情報を更新しない。更新が必要な場合は identity 経由で行う。

### Q: 既存システムからの移行はどう行うのか

**A:** 段階移行を前提とする。

1. 共通基盤（identity / household）を先行構築
2. 業務ドメインを順次移行（gojo → funeral → bridal → point）
3. 移行期間中は既存システムとデータ同期を行う

一括移行ではなく、機能単位・法人単位での段階移行を想定している。

---

## 8. この文書の使い方

### 位置付け

本文書は NEXUS の「全体像と設計判断」を説明する。

- 実装詳細は各モジュールの README を参照
- 設計方針は [README.md](../../README.md) を参照
- Task 共通設計は [common/task/README.md](../../common/task/README.md) を参照

### 設計判断に迷ったとき

実装中に「この処理はどこに置くべきか」と迷った場合：

1. 本文書の「ドメイン間の関係」を確認する
2. README の「設計原則」を確認する
3. 該当ドメインの README を確認する
4. それでも判断できない場合はチームで議論し、本文書を更新する

### 更新ルール

アーキテクチャに関する決定事項は、本文書に反映する。

- 口頭での決定事項も文書化する
- 「例外」を増やすのではなく、原則を見直す
- 更新時は PR でレビューを受ける
