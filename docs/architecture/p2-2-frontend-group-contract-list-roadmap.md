# P2-2: Frontend 本格接続（Group Contract List）詳細ロードマップ

本ドキュメントは、P2-2（Frontend 本格接続）フェーズにおける **Group Contract List 画面完成**のための詳細ロードマップを定義する。

**本書の位置づけ**: P2-2 実装の正本。P2-2 の実装は本書に従って進める。

**設計の正（参照必須）**:
- docs/architecture/nexus-design-constitution.md
- docs/architecture/nexus-project-roadmap.md
- docs/architecture/p1-b0-group-contract-display-requirements.md
- docs/architecture/p1-b1-completion.md
- docs/architecture/p1-b2-completion.md
- docs/architecture/p1-a2-completion.md
- docs/architecture/p2-detailed-roadmap.md

---

## 1. P2-2 の目的（What）

- Frontend（Next.js）と Backend BFF の **完全統合**を成立させる
- Group Contract List 画面を「業務 UI として事故らない」水準で完成させる
- Region（`X-NEXUS-REGION`）を Frontend 側で **明示状態として扱う**（暗黙補完禁止）

---

## 2. 前提（事実・再解釈禁止）

- 認証（NextAuth×Keycloak）および BFF 認可・Context set は P2-1 / P1-A 系で成立済み
- 表示要件・検索条件・ソート・ページング仕様は **P1-B0 を正**とする（現状 P1-B0 は未着手であるため、P2-2 の先行タスクとして扱う）
- Backend は FAIL FAST 前提（403/404/400 を握りつぶさない）

---

## 3. 禁止事項（P2-2 固有）

- Region の自動補完（token 解析 / 固定値 / localStorage 既定値 / URL からの暗黙決定 など）
- 初期表示時の全件検索（初期表示では検索を実行しない）
- 「とりあえず動かす」ための暫定 UI・暫定 API 呼び出し
- Frontend が業務判断する実装（例：契約状態の解釈、権限の推測、バックエンドの代替ロジック）

---

## 4. P2-2 サブタスク一覧（依存順）

> 各サブタスクは「目的 / スコープ / Done 条件」を必ず満たす。
> Done を満たさないまま次へ進むことは禁止。

### P2-2-0: P1-B0（表示要件確定）の確定（P2-2 ブロッカー）

**目的**: Group Contract List の UI/ソート/ページング/表示項目の「正」を確定させる。

**スコープ**:
- `p1-b0-group-contract-display-requirements.md` を作成/確定する
- 一覧の MUST 表示項目、検索条件、ソートキー、ページング仕様を明文化する
- Backend の既存 API レスポンスとのキー整合を確認し、差分があれば「どちらを正にするか」を P1-B0 で確定する

**Done 条件**:
- P1-B0 ドキュメントが存在し、MUST/SHOULD が確定している
- Frontend 実装が参照できる「表示項目」「検索条件」「ソート」「ページング」がドキュメントで一意になる

---

### P2-2-1: 現状確認と接続インターフェース固定

**目的**: 実装に入る前に「正しい接続面」を確定し、暗黙のズレを排除する。

**スコープ**:
- BFF の検索 API 仕様（path / method / query param / response shape / error shape）を確認し、Frontend 側の型定義・呼び出し箇所と整合していることを確認
- 表示要件（P1-B0）の **APIキー** と Frontend 側の表示項目が一致していることを確認
- 既存 Frontend 実装に存在する「検索済み/未検索」「ページ/サイズ/ソート」「エラー表示」などの状態管理方針を棚卸し

**Done 条件**:
- Frontend が呼ぶ API の **正しい URL / method / param** が、P1-B0 と実装の両面で矛盾なく確定している
- 画面で表示する最低限の列（P1-B0 の MUST）と、現行レスポンスのキーが一致している（不一致は P2-2 ブロッカーとして明文化）

---

### P2-2-2: Region の明示管理（UI 状態としての Region）

**目的**: Region を「必須ヘッダー」ではなく **ユーザーが把握できる状態**として扱い、未設定を許容しつつ事故を防ぐ。

**スコープ**:
- Region 状態を Frontend の状態として保持する（未設定を許容）
- UI 上で Region が「未設定 / 設定済み」を明示する
- Region 未設定時は **検索を含む API を一切実行しない**
- Region の設定導線は「明示的操作」のみで成立させる

**Done 条件**:
- Region 未設定で画面が成立し、ユーザーに「未設定で検索できない」ことが明示される
- Region をユーザーが明示設定した後のみ、検索等の API を実行できる
- Region の自動補完が存在しない（コード上の既定値/自動推測がない）

---

### P2-2-3: API 呼び出し層の統合（`X-NEXUS-REGION` 必須付与）

**目的**: すべての BFF リクエストが設計どおり **必須ヘッダーを付与**し、未設定は FAIL FAST（＝呼ばない）にする。

**スコープ**:
- API クライアント層で `X-NEXUS-REGION` を必ず付与する（付与漏れできない構造）
- Region 未設定時は **呼び出し自体を禁止**する（UI 側で抑止）
- 認証（Authorization）と Region の双方が揃って初めて呼べる責務境界を明確化

**Done 条件**:
- Group 検索 API への全リクエストに `X-NEXUS-REGION` が付与される
- Region 未設定時は API が実行されない（ネットワークログで確認可能）
- 付与漏れが構造的に起きない（呼び出し口が一本化されている）

---

### P2-2-4: 検索フォーム（初期非実行・入力の明示・形式バリデーション）

**目的**: 「初期検索しない」「入力を隠さない」を守った検索 UI を成立させる。

**スコープ**:
- 初期表示では検索を実行しない
- P1-B0 の検索条件に従って入力欄を持ち、入力値を明示的に画面に保持する
- 明白な形式不正は送らない（業務判断はしない）

**Done 条件**:
- 初期表示では API を呼ばない
- 検索ボタン押下でのみ検索 API が呼ばれる（Region 設定済み前提）
- 形式不正の入力は UI 上で検知され、400 を誘発する入力を抑止できる

---

### P2-2-5: 結果テーブル（表示要件準拠）

**目的**: P1-B0 の表示要件を正として、一覧表示を破綻なく成立させる。

**スコープ**:
- 表示項目は P1-B0 の MUST を優先して実装する
- null 許容項目は UI 上で「値がない」ことが分かる表現にする
- 行の識別（key）を安定させる

**Done 条件**:
- 一覧表示が P1-B0 の MUST を満たし、項目欠落やキー不一致がない
- null 許容項目の表示ルールが固定され、状態を隠さない

---

### P2-2-6: ページネーション・ソート（P1-B0 準拠）

**目的**: 検索結果を「正しく切る・正しく並べる」操作が成立する。

**スコープ**:
- ページング（page/size）を UI と API で整合させる
- ソート指定を UI で明示できるようにする（仕様は P1-B0）
- 「未検索」状態ではページ/ソート操作で API を呼ばない

**Done 条件**:
- ページサイズ変更・ページ移動が正しく動作する
- ソート条件の変更が正しく動作する
- 「未検索」状態ではページ/ソート操作で API を呼ばない

---

### P2-2-7: エラー表示（400 / 403 / 404 / 500）

**目的**: 事故時に「何が起きているか」を UI で明示し、握りつぶさない。

**スコープ**:
- 400/403/404/500 を区別して表示する
- エラー時に「成功したように見える」表示にしない

**Done 条件**:
- ステータスごとに UI 表示が分岐し、ユーザーが判断できる情報として提示される
- エラー時に状態を隠さない

---

### P2-2-8: 検証（E2E / 手動）とドキュメント更新

**目的**: 実装の成立を「検証可能な形」で固定する。

**スコープ**:
- 手動検証手順（Region 未設定/設定、検索未実行/実行、各種エラー）を docs に明文化
- E2E 観点（Frontend→Keycloak→BFF→DB）のチェック項目を docs に明文化

**Done 条件**:
- P2-2 の手動検証手順が docs に明文化されている
- P2-2 の E2E 観点のチェックが docs に明文化されている

---

## 5. P2-2 の完了条件（フェーズ Done）

- Region が明示状態として扱われ、未設定時に API を実行しない
- `X-NEXUS-REGION` が全 API リクエストに必須付与されている（未設定時は実行しない）
- 初期表示で検索を実行しない
- 検索・ページング・ソートが P1-B0 準拠で成立する
- 400 / 403 / 404 / 500 の表示が成立し、状態を隠さない
- 検証ドキュメント（手動/E2E）が更新されている

---

## 6. 推奨順序

1. P2-2-0（P1-B0 確定）
2. P2-2-1（現状確認）
3. P2-2-2（Region 明示管理）
4. P2-2-3（API 呼び出し統合）
5. P2-2-4（検索フォーム）
6. P2-2-5（一覧表示）
7. P2-2-6（ページング/ソート）
8. P2-2-7（エラー表示）
9. P2-2-8（検証ドキュメント更新）
