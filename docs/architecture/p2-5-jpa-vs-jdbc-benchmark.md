# P2-5-EX: JDBC vs JPA 同一仕様ベンチマーク（回帰検証）

本ドキュメントは、P2-5-EX として実施する「JDBC vs JPA 同一仕様ベンチマーク」の結果を記録する正本である。

**本書の位置づけ**: P2-5-EX の比較検証結果の正本。判断材料として記録する。

**設計の正（参照必須）**:
- [nexus-design-constitution.md](./nexus-design-constitution.md)
- [nexus-project-roadmap.md](./nexus-project-roadmap.md)
- [p2-5-performance-optimization-roadmap.md](./p2-5-performance-optimization-roadmap.md)

---

## 1. 目的 / 前提

### 1.1 目的

- JDBC採用理由の再検証（SQL条件の書き方起因かを含め比較）
- 置換ではなく比較検証（判断材料の記録）
- 同一仕様での動作確認と性能比較

### 1.2 前提

- P2-3を壊さない（認証/認可/権限制御/表示制御は成立済み）
- 置換ではない（検証のみ）
- 同一仕様での比較（検索条件/ソート/ページング/件数一致）

### 1.3 位置づけ

- P2-5の最後に実施（置換ではなく比較検証）
- 判断材料として記録する（推測禁止）

---

## 2. 比較対象

### 2.1 JDBC版

- 現行実装（P2-4完了時点）
- SQLを正とした設計
- DTO / RowMapper / Controller 構成

### 2.2 JPA版

- 検証用実装（profile切替 or 別エンドポイント）
- 同一仕様での実装
- 本番適用はしない

---

## 3. 仕様一致チェックリスト

### 3.1 検索条件

- [ ] 検索条件の一致（全条件で同一結果）
- [ ] 空文字/未指定の扱いの一致
- [ ] バリデーションの一致（400条件）

### 3.2 ソート

- [ ] ソート順の一致（許可キー、デフォルト、方向）
- [ ] 不正ソートキー時の扱いの一致（400）

### 3.3 ページング

- [ ] ページングの一致（page/size、デフォルト、上限）
- [ ] 上限超過時の扱いの一致（400）

### 3.4 件数

- [ ] Search と Count の整合（同条件で同件数）
- [ ] FROM/WHERE一致の確認

### 3.5 認証認可

- [ ] P2-3の認証認可前提維持
- [ ] 権限制御の一致

---

## 4. 計測条件

### 4.1 代表クエリ

- 代表的な検索条件の組み合わせを選定
- 実データ量を前提とした条件

### 4.2 データ前提

- 実データ量（約470万件）を前提
- 権限スコープを考慮

### 4.3 環境

- 同一環境での計測
- 同一データベース接続

### 4.4 計測回数

- 複数回実行して平均値を記録
- 外れ値の除外方法を明記

### 4.5 計測方法

- 実行時間の計測
- 実行計画（EXPLAIN PLAN）の取得
- メモリ使用量の計測（必要に応じて）

---

## 5. 結果

### 5.1 実行時間の比較

| 検索条件 | JDBC版（平均） | JPA版（平均） | 差分 |
|---------|---------------|--------------|------|
| （代表クエリ1） | （秒） | （秒） | （秒） |
| （代表クエリ2） | （秒） | （秒） | （秒） |
| （代表クエリ3） | （秒） | （秒） | （秒） |

### 5.2 実行計画の要点

- JDBC版の実行計画の要点
- JPA版の実行計画の要点
- 差分の分析

### 5.3 観測ログ

- 実行時のログ（必要に応じて）
- エラーの有無

---

## 6. 結論

### 6.1 判断材料

- 性能比較の結果
- 保守性の比較（必要に応じて）
- 可読性の比較（必要に応じて）

### 6.2 採用/不採用/条件付き

- 判断材料として記録（推測禁止）
- 今後の判断に活用

---

## 7. 付録

### 7.1 実行したSQL/パラメータ例

- JDBC版のSQL例
- JPA版のクエリ例（必要に応じて）
- パラメータ例

### 7.2 実行計画の詳細

- JDBC版の実行計画（全文）
- JPA版の実行計画（全文）

---

## 8. 参照

- [p2-5-performance-optimization-roadmap.md](./p2-5-performance-optimization-roadmap.md)（P2-5 詳細ロードマップ）
- [nexus-design-constitution.md](./nexus-design-constitution.md)（設計憲法）

---

## 9. 注意事項

- 本ベンチマークは検証のみ（置換ではない）
- 推測禁止（実測のみ記録）
- P2-3を壊さない前提

---

以上。
