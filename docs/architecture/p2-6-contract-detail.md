# P2-6: 法人横断契約詳細画面 設計判断

本ドキュメントは、P2-6（法人横断契約一覧→詳細遷移）フェーズにおける設計判断を記録する。

**設計の正（参照必須）**:
- [nexus-design-constitution.md](./nexus-design-constitution.md)
- [nexus-project-roadmap.md](./nexus-project-roadmap.md)

---

## 契約状態（contract_status）を BFF で組み立てている理由

一覧・詳細で表示される `contract_status` は、
DB の単一カラムではなく、複数の状態区分・理由区分を
組み合わせた **表示専用の派生値** である。

当初は SQL（CASE 式）で組み立てていたが、
以下の理由により **BFF 層での組み立てに統一**している。

### 理由 1: 一覧・詳細で完全に同一の表示ロジックを保証するため

一覧検索・詳細取得は別 SQL を使用しており、
SQL CASE をそれぞれに持たせると、
将来的にロジック差分が生じるリスクが高い。

BFF に共通ロジック（ContractStatusBuilder）を集約することで、
一覧・詳細の表示不整合を構造的に防止している。

### 理由 2: SQL の肥大化・可読性低下を防ぐため

contract_status の CASE ロジックは条件分岐が多く、
SQL に埋め込むと JOIN + CASE が過度に複雑化する。

SQL は「材料の取得」に責務を限定し、
表示ロジックは Kotlin で明示的に表現する方が
保守性・レビュー性が高い。

### 理由 3: 将来の表示仕様変更に DB 影響を出さないため

契約状態の表示文言・組み立て順は
業務要件により変更される可能性が高い。

BFF 層で組み立てることで、
- SQL 修正
- DB リリース
を伴わずに表示調整が可能となる。

### 対応方針

- SQL: 状態区分・理由区分などの「材料」をそのまま返す
- BFF: SQL CASE と **1:1 対応する Kotlin ロジック**で contract_status を生成
- Frontend: contract_status をそのまま表示（業務判断なし）

この方針は P2-6 時点で確定しており、
以降の実装では踏襲するものとする。
